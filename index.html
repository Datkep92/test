<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Quản lý Kinh doanh (Firebase)</title>
  <style>
    * { box-sizing: border-box; font-family: Arial; }
    body { margin: 0; background: #f5f5f5; }
    header { padding: 12px; background: #333; color: white; display: flex; justify-content: space-between; align-items: center; }
    .btn { padding: 8px 12px; border: none; cursor: pointer; border-radius:4px; }
    .btn-danger { background: #e74c3c; color:white; }
    .container { max-width:800px; margin:20px auto; background:white; padding:16px; border-radius:6px; }
    input,button,textarea,select { width:100%; margin:6px 0; padding:8px; border:1px solid #ccc; border-radius:4px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { padding:8px; border:1px solid #ddd; }
    th { background:#eee; }
    .hidden { display:none; }
    .tabs { display:flex; gap:10px; flex-wrap:wrap; }
    .tabs button.active { background:#3498db; color:white; }
    .tabs button { background:#ddd; }
    #logoutBtn { background:#e74c3c; color:white; padding:6px 10px; }
  </style>
</head>
<body>

  <header>
    <div><h2>Quản lý Kinh doanh</h2></div>
    <div>
      <span id="currentUser" style="margin-right:10px"></span>
      <button id="logoutBtn" class="hidden">🚪 Đăng xuất</button>
    </div>
  </header>

  <div class="container" id="loginBox">
    <h3>🔐 Đăng nhập</h3>
    <input type="email" id="loginEmail" placeholder="Email người dùng" />
    <input type="password" id="loginPassword" placeholder="Mật khẩu" />
    <button id="loginBtn" class="btn">Đăng nhập</button>
  </div>

  <div class="container hidden" id="mainApp">
    <!-- Tabs -->
    <div class="tabs">
      <button id="tabChiPhi" class="active">Chi phí</button>
      <button id="tabGhiChu">Ghi chú</button>
      <button id="tabBaoCao">Báo cáo</button>
      <button id="tabNguoiDung" class="hidden">Quản lý User</button>
    </div>

    <!-- Chi phí -->
    <div id="chiPhiTab">
      <input type="text" id="expenseInput" placeholder="VD: mua xăng 50000" />
      <button id="addExpenseBtn" class="btn btn-success">Thêm Chi phí</button>
      <table>
        <thead><tr><th>Mô tả</th><th>Số tiền</th><th>Xoá</th></tr></thead>
        <tbody id="expenseTable"></tbody>
      </table>
    </div>

    <!-- Ghi chú -->
    <div id="ghiChuTab" class="hidden">
      <textarea id="notesTextarea" rows="4" placeholder="Viết ghi chú cá nhân..."></textarea>
      <button id="saveNotesBtn" class="btn btn-success">Lưu Ghi chú</button>
    </div>

    <!-- Báo cáo -->
    <div id="baoCaoTab" class="hidden">
      <button id="reportBtn" class="btn">Xem báo cáo hôm nay</button>
      <p>Doanh thu: <span id="dailyRevenue">0₫</span></p>
      <p>Chi phí: <span id="dailyExpenses">0₫</span></p>
      <p>Lợi nhuận: <span id="dailyBalance">0₫</span></p>
    </div>

    <!-- Quản lý người dùng -->
    <div id="nguoiDungTab" class="hidden">
      <input type="email" id="newUserEmail" placeholder="Email user" />
      <input type="password" id="newUserPassword" placeholder="Mật khẩu" />
      <select id="newUserRole">
        <option value="staff">Nhân viên</option>
        <option value="manager">Quản lý</option>
      </select>
      <button id="addUserBtn" class="btn btn-success">Thêm User</button>
      <table>
        <thead><tr><th>Email</th><th>Role</th><th>Xoá</th></tr></thead>
        <tbody id="userTable"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, query, where, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const config = {
      apiKey: "AIzaSyDmFpKa8TpDjo3pQADaTubgVpDPOi-FPXk",
      authDomain: "quanly-d7e54.firebaseapp.com",
      projectId: "quanly-d7e54",
      storageBucket: "quanly-d7e54.appspot.com",
      messagingSenderId: "482686011267",
      appId: "1:482686011267:web:f2fe9d400fe618487a98b6"
    };
    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI elements
    const loginBox = document.getElementById("loginBox");
    const mainApp = document.getElementById("mainApp");
    const currentUserSpan = document.getElementById("currentUser");
    const logoutBtn = document.getElementById("logoutBtn");
    const expenseInput = document.getElementById("expenseInput");
    const addExpenseBtn = document.getElementById("addExpenseBtn");
    const expenseTable = document.getElementById("expenseTable");
    const notesTextarea = document.getElementById("notesTextarea");
    const saveNotesBtn = document.getElementById("saveNotesBtn");
    const reportBtn = document.getElementById("reportBtn");
    const dailyRevenue = document.getElementById("dailyRevenue");
    const dailyExpenses = document.getElementById("dailyExpenses");
    const dailyBalance = document.getElementById("dailyBalance");
    const newUserEmail = document.getElementById("newUserEmail");
    const newUserPassword = document.getElementById("newUserPassword");
    const newUserRole = document.getElementById("newUserRole");
    const addUserBtn = document.getElementById("addUserBtn");
    const userTable = document.getElementById("userTable");
    const tabChiPhi = document.getElementById("tabChiPhi");
    const tabGhiChu = document.getElementById("tabGhiChu");
    const tabBaoCao = document.getElementById("tabBaoCao");
    const tabNguoiDung = document.getElementById("tabNguoiDung");
    const chiPhiTab = document.getElementById("chiPhiTab");
    const ghiChuTab = document.getElementById("ghiChuTab");
    const baoCaoTab = document.getElementById("baoCaoTab");
    const nguoiDungTab = document.getElementById("nguoiDungTab");

    let currentUser = null;
    let userRole = "staff";

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        loginBox.classList.add("hidden");
        mainApp.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");
        currentUserSpan.textContent = user.email;

        const docUser = await getDoc(doc(db, "users", user.uid));
        if (docUser.exists()) userRole = docUser.data().role || "staff";
        if (userRole === "manager") tabNguoiDung.classList.remove("hidden");

        loadExpenses();
        loadNotes();
        if (userRole === "manager") loadUsers();
      } else {
        currentUser = null;
        loginBox.classList.remove("hidden");
        mainApp.classList.add("hidden");
        logoutBtn.classList.add("hidden");
      }
    });

    document.getElementById("loginBtn").onclick = () => {
      signInWithEmailAndPassword(auth, document.getElementById("loginEmail").value, document.getElementById("loginPassword").value)
        .catch(e => alert("Đăng nhập lỗi: " + e.message));
    };
    logoutBtn.onclick = () => signOut(auth);

    addExpenseBtn.onclick = async () => {
      const [m, d] = expenseInput.value.trim().match(/(.+?)\s+(\d+)/) || [];
      if (!m || !d) return alert("Sai cú pháp chi phí");
      await addDoc(collection(db, "expenses"), { uid: currentUser.uid, description: m, amount: parseInt(d), timestamp: serverTimestamp() });
      expenseInput.value = "";
      loadExpenses();
    };

    async function loadExpenses() {
      expenseTable.innerHTML = "<tr><td colspan=3>Đang tải...</td></tr>";
      const q = query(collection(db, "expenses"), where("uid", "==", currentUser.uid));
      const snap = await getDocs(q);
      let html = "";
      snap.forEach(docSnap => {
        const e = docSnap.data();
        html += `<tr><td>${e.description}</td><td>${e.amount}₫</td><td><button onclick="deleteExpense('${docSnap.id}')">❌</button></td></tr>`;
      });
      expenseTable.innerHTML = html || "<tr><td colspan=3>Không có</td></tr>";
    }
    window.deleteExpense = async id => { await deleteDoc(doc(db, "expenses", id)); loadExpenses(); };

    saveNotesBtn.onclick = async () => {
      await setDoc(doc(db, "notes", currentUser.uid), { note: notesTextarea.value });
      alert("Ghi chú đã lưu");
    };
    async function loadNotes() {
      const nd = await getDoc(doc(db, "notes", currentUser.uid));
      if (nd.exists()) notesTextarea.value = nd.data().note;
    }

    reportBtn.onclick = async () => {
      const td = new Date().toISOString().split("T")[0];
      const s = new Date(td), e = new Date(td); e.setDate(e.getDate()+1);
      const pe = query(collection(db,"expenses"), where("uid","==",currentUser.uid), where("timestamp",">=",s), where("timestamp","<",e));
      const pr = query(collection(db,"revenue"), where("uid","==",currentUser.uid), where("timestamp",">=",s), where("timestamp","<",e));
      const [xe, xr] = await Promise.all([getDocs(pe), getDocs(pr)]);
      let te=0, tr=0;
      xe.forEach(d=>te+=d.data().amount);
      xr.forEach(d=>tr+=d.data().amount);
      dailyExpenses.textContent = te.toLocaleString("vi-VN") + "₫";
      dailyRevenue.textContent = tr.toLocaleString("vi-VN") + "₫";
      dailyBalance.textContent = (tr - te).toLocaleString("vi-VN") + "₫";
    };

    addUserBtn.onclick = async () => {
      if (userRole!=="manager") return;
      const em = newUserEmail.value, pw = newUserPassword.value, rl = newUserRole.value;
      try {
        const cr = await createUserWithEmailAndPassword(auth,em,pw);
        await setDoc(doc(db,"users",cr.user.uid),{email:em,role:rl});
        newUserEmail.value=""; newUserPassword.value="";
        loadUsers();
      } catch(e){ alert("Lỗi tạo user: "+e.message); }
    };
    async function loadUsers() {
      if (userRole!=="manager") return;
      const snap = await getDocs(collection(db,"users"));
      let html="";
      snap.forEach(docSnap => {
        const u = docSnap.data();
        html += `<tr><td>${u.email}</td><td>${u.role}</td><td><button onclick="deleteUser('${docSnap.id}')">❌</button></td></tr>`;
      });
      userTable.innerHTML=html||"<tr><td colspan=3>Không có</td></tr>";
    }
    window.deleteUser = async uid => { if (userRole==="manager") await deleteDoc(doc(db,"users",uid)); loadUsers(); };

    // Tab switching
    [tabChiPhi,tabGhiChu,tabBaoCao,tabNguoiDung].forEach((btn,i) => {
      btn.onclick = () => {
        [chiPhiTab,ghiChuTab,baoCaoTab,nguoiDungTab].forEach(el=>el.classList.add("hidden"));
        [tabChiPhi,tabGhiChu,tabBaoCao,tabNguoiDung].forEach(b=>b.classList.remove("active"));
        [chiPhiTab,ghiChuTab,baoCaoTab,nguoiDungTab][i].classList.remove("hidden");
        btn.classList.add("active");
      };
    });
  </script>
</body>
</html>
