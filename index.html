<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản lý Kinh doanh</title>
  <style>
    /* Your existing CSS styles remain exactly the same */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
    }
    
    body {
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }
    
    /* ... (keep all your existing styles) ... */
  </style>
</head>
<body>
  <!-- Your existing HTML structure remains the same -->
  <header id="appHeader" class="hidden">
    <h1>📊 Quản lý Kinh doanh</h1>
    <div class="user-info">
      <span id="currentUser"></span>
      <button onclick="handleLogout()" class="logout-btn danger">Đăng xuất</button>
    </div>
  </header>
  
  <!-- Login Screen -->
  <div class="container">
    <div class="login-box" id="loginBox">
      <h3 class="text-center">🔐 Đăng nhập</h3>
      <div id="errorContainer"></div>
      <input type="text" id="username" placeholder="Tên đăng nhập" autocomplete="username" />
      <input type="password" id="password" placeholder="Mật khẩu" autocomplete="current-password" />
      <label>
        <input type="checkbox" id="rememberMe" checked /> Ghi nhớ đăng nhập
      </label>
      <button onclick="handleLogin()" class="success">Đăng nhập</button>
    </div>
  </div>

  <!-- Your other screens (Sale, Admin) remain exactly the same -->
  
  <!-- Firebase Integration -->
  <script type="module">
    // Import Firebase services
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      signOut,
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      getDatabase, 
      ref, 
      set, 
      get,
      child,
      push,
      update,
      remove,
      onValue 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDmFpKa8TpDjo3pQADaTubgVpDPOi-FPXk",
      authDomain: "quanly-d7e54.firebaseapp.com",
      databaseURL: "https://quanly-d7e54-default-rtdb.firebaseio.com",
      projectId: "quanly-d7e54",
      storageBucket: "quanly-d7e54.firebasestorage.app",
      messagingSenderId: "482686011267",
      appId: "1:482686011267:web:f2fe9d400fe618487a98b6"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // Application data structure
    let currentUser = null;
    let currentTab = 'expense';
    let selectedProduct = null;

    // Initialize the app
    function initApp() {
      // Set current date in report date picker
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('reportDate').value = today;
      
      // Load remembered user
      const rememberedUser = localStorage.getItem('rememberedUser');
      if (rememberedUser) {
        document.getElementById('username').value = rememberedUser;
        document.getElementById('password').focus();
      }
      
      // Event listeners
      document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
      });
      
      document.getElementById('expenseInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') addExpense();
      });
      
      document.getElementById('revenueAmount').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') addRevenue();
      });
      
      // Check auth state
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user.uid;
          handleSuccessfulLogin();
        }
      });
    }
    
    // Login functions
    async function handleLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const rememberMe = document.getElementById('rememberMe').checked;
      
      // Clear previous errors
      document.getElementById('errorContainer').innerHTML = '';
      
      if (!username || !password) {
        showError('Vui lòng nhập đầy đủ thông tin đăng nhập');
        return;
      }
      
      try {
        // Firebase requires email format, so we'll create a dummy email
        const email = `${username}@quanly-hkd.com`;
        
        // Sign in with Firebase Auth
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        
        // Remember user if needed
        if (rememberMe) {
          localStorage.setItem('rememberedUser', username);
        } else {
          localStorage.removeItem('rememberedUser');
        }
        
        currentUser = userCredential.user.uid;
        handleSuccessfulLogin();
        
      } catch (error) {
        console.error("Login error:", error);
        let errorMessage = "Đăng nhập thất bại";
        
        if (error.code === "auth/invalid-credential") {
          errorMessage = "Sai tên đăng nhập hoặc mật khẩu";
        } else if (error.code === "auth/too-many-requests") {
          errorMessage = "Quá nhiều lần thử, vui lòng thử lại sau";
        }
        
        showError(errorMessage);
      }
    }
    
    async function handleSuccessfulLogin() {
      document.getElementById('loginBox').classList.add('hidden');
      document.getElementById('appHeader').classList.remove('hidden');
      
      // Get user data from database
      const userRef = ref(database, `users/${currentUser}`);
      const snapshot = await get(userRef);
      
      if (snapshot.exists()) {
        const userData = snapshot.val();
        document.getElementById('currentUser').textContent = userData.username;
        
        if (userData.role === 'admin') {
          document.getElementById('adminApp').classList.remove('hidden');
          renderUserList();
          loadReportFilters();
        } else {
          document.getElementById('saleApp').classList.remove('hidden');
        }
        
        loadData();
      } else {
        showError('Không tìm thấy thông tin người dùng');
        handleLogout();
      }
    }
    
    async function handleLogout() {
      try {
        await signOut(auth);
        currentUser = null;
        document.getElementById('loginBox').classList.remove('hidden');
        document.getElementById('appHeader').classList.add('hidden');
        document.getElementById('adminApp').classList.add('hidden');
        document.getElementById('saleApp').classList.add('hidden');
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
      } catch (error) {
        console.error("Logout error:", error);
      }
    }
    
    // Data functions
    async function loadData() {
      const today = new Date().toLocaleDateString('vi-VN');
      document.getElementById('summaryDate').textContent = today;
      
      // Load products
      const productsRef = ref(database, 'products');
      onValue(productsRef, (snapshot) => {
        products = snapshot.val() || [];
        renderProducts();
        if (currentTab === 'export') {
          renderProductSelection();
        }
      });
      
      // Load expense categories
      const categoriesRef = ref(database, 'expenseCategories');
      onValue(categoriesRef, (snapshot) => {
        expenseCategories = snapshot.val() || [];
      });
      
      // Load today's data
      const dailyDataRef = ref(database, `dailyData/${currentUser}/${today}`);
      onValue(dailyDataRef, (snapshot) => {
        dailyData = snapshot.val() || {
          date: today,
          expenses: [],
          exports: [],
          revenue: 0,
          note: '',
          user: currentUser
        };
        document.getElementById('dailyNote').value = dailyData.note || '';
        renderDailyData();
      });
    }
    
    async function saveDailyData() {
      const today = new Date().toLocaleDateString('vi-VN');
      dailyData.note = document.getElementById('dailyNote').value;
      
      try {
        await set(ref(database, `dailyData/${currentUser}/${today}`), dailyData);
        alert('Đã lưu dữ liệu ngày ' + today);
      } catch (error) {
        console.error("Error saving daily data:", error);
        alert('Lỗi khi lưu dữ liệu');
      }
    }
    
    // ... (rest of your existing functions with Firebase database calls) ...
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>