<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản lý Kinh doanh (Firebase)</title>
  <script type="module">
    // ✅ Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ✅ Config Firebase của bạn
    const firebaseConfig = {
      apiKey: "AIzaSyDmFpKa8TpDjo3pQADaTubgVpDPOi-FPXk",
      authDomain: "quanly-d7e54.firebaseapp.com",
      projectId: "quanly-d7e54",
      storageBucket: "quanly-d7e54.appspot.com",
      messagingSenderId: "482686011267",
      appId: "1:482686011267:web:f2fe9d400fe618487a98b6",
      measurementId: "G-G3H6MTCWCM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ✅ DOM ready
    window.addEventListener("DOMContentLoaded", () => {
      const loginBox = document.getElementById("loginBox");
      const appContent = document.getElementById("mainApp");
      const btnLogout = document.getElementById("logoutBtn");
      const btnLogin = document.getElementById("loginBtn");
      const inputEmail = document.getElementById("email");
      const inputPassword = document.getElementById("password");
      const transactionInput = document.getElementById("transactionInput");
      const transactionTable = document.querySelector("#transactionTable tbody");

      let currentUser = null;

      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          loginBox.style.display = "none";
          appContent.style.display = "block";
          document.getElementById("currentUser").innerText = user.email;
          loadTransactions();
        } else {
          currentUser = null;
          loginBox.style.display = "block";
          appContent.style.display = "none";
        }
      });

      btnLogin.onclick = async () => {
        try {
          await signInWithEmailAndPassword(auth, inputEmail.value.trim(), inputPassword.value.trim());
        } catch (err) {
          alert("🚫 Đăng nhập thất bại: " + err.message);
        }
      };

      btnLogout.onclick = async () => {
        await signOut(auth);
      };

      document.getElementById("btnAddTransaction").onclick = async () => {
        const raw = transactionInput.value.trim();
        const match = raw.match(/(\d[\d.,]*)/);
        if (!match) return alert("❌ Không tìm thấy số tiền");

        const amount = parseInt(match[1].replace(/[.,]/g, ""));
        const label = raw.replace(match[0], "").trim();
        const type = label.toLowerCase().includes("bán") || label.toLowerCase().includes("thu") ? "Doanh thu" : "Chi phí";

        const newData = {
          uid: currentUser.uid,
          type,
          label,
          amount,
          timestamp: serverTimestamp()
        };

        try {
          await addDoc(collection(db, "transactions"), newData);
          transactionInput.value = "";
          loadTransactions();
        } catch (err) {
          alert("❌ Không thể thêm giao dịch: " + err.message);
        }
      };

      async function loadTransactions() {
        transactionTable.innerHTML = "<tr><td colspan='4'>⏳ Đang tải...</td></tr>";
        const snapshot = await getDocs(collection(db, "transactions"));
        let html = "";
        let total = 0;
        snapshot.forEach(doc => {
          const t = doc.data();
          if (t.uid !== currentUser.uid) return;
          html += `<tr>
            <td>${t.type}</td>
            <td>${t.label}</td>
            <td>${t.amount.toLocaleString("vi-VN")}₫</td>
            <td>🕒</td>
          </tr>`;
          total += (t.type === "Doanh thu" ? t.amount : -t.amount);
        });
        transactionTable.innerHTML = html || "<tr><td colspan='4'>📭 Không có dữ liệu</td></tr>";
        document.getElementById("dailySummary").innerText = "Tổng: " + total.toLocaleString("vi-VN") + "₫";
      }
    });
  </script>
  <style>
    * { font-family: sans-serif; box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #f0f0f0; }
    header { background: #222; color: white; padding: 12px; text-align: center; }
    .container { max-width: 600px; margin: 24px auto; background: white; padding: 16px; border-radius: 8px; }
    input, button { padding: 8px; margin: 6px 0; width: 100%; border: 1px solid #ccc; border-radius: 6px; }
    table { width: 100%; margin-top: 16px; border-collapse: collapse; }
    td, th { border: 1px solid #ddd; padding: 8px; }
    th { background: #eee; }
    #mainApp { display: none; }
  </style>
</head>
<body>
  <header>
    <h2>📊 Quản lý Kinh doanh</h2>
    <div id="currentUser"></div>
  </header>

  <div class="container" id="loginBox">
    <h3>🔐 Đăng nhập</h3>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Mật khẩu" />
    <button id="loginBtn" class="success">Đăng nhập</button>
  </div>

  <div class="container" id="mainApp">
    <h3>📝 Giao dịch hôm nay</h3>
    <input type="text" id="transactionInput" placeholder="VD: bán cà phê 12000" />
    <button id="btnAddTransaction">Thêm giao dịch</button>
    <table id="transactionTable">
      <thead>
        <tr><th>Loại</th><th>Chi tiết</th><th>Số tiền</th><th>#</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="dailySummary"></div>
    <button id="logoutBtn">🚪 Đăng xuất</button>
  </div>
</body>
</html>
