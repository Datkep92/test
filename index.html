<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quáº£n lÃ½ Há»™ Kinh Doanh (HKD)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header { background: #2c3e50; color: white; padding: 10px 20px; }
    .tabs { display: flex; background: #ecf0f1; border-bottom: 1px solid #ccc; }
    .tab { padding: 10px 20px; cursor: pointer; }
    .tab.active { background: white; border-top: 2px solid #3498db; font-weight: bold; }
    .tab-content { display: none; padding: 20px; }
    .tab-content.active { display: block; }
    input[type="file"], input[type="text"] { margin-top: 10px; padding: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; font-size: 14px; }
  </style>
</head>
<body>
  <header>
    <h2>ğŸ“Š Quáº£n lÃ½ Há»™ Kinh Doanh</h2>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="showTab('uploadTab')">ğŸ“¥ Táº£i HÃ³a Ä‘Æ¡n</div>
    <div class="tab" onclick="showTab('summaryTab')">ğŸ“‹ Danh sÃ¡ch HKD</div>
    <div class="tab" onclick="showTab('stockTab')">ğŸ“¦ Tá»“n kho</div>
    <div class="tab" onclick="showTab('searchTab')">ğŸ” TÃ¬m kiáº¿m HÄ</div>
  </div>

  <div id="uploadTab" class="tab-content active">
    <h3>ğŸ§¾ Nháº­p file ZIP chá»©a hÃ³a Ä‘Æ¡n HTML</h3>
    <input type="file" id="zipInput" accept=".zip" multiple />
    <p id="status"></p>
  </div>

  <div id="summaryTab" class="tab-content">
    <input type="text" id="searchHKD" placeholder="ğŸ” TÃ¬m kiáº¿m theo MST HKD...">
    <div id="hkdList"></div>
  </div>

  <div id="stockTab" class="tab-content">
    <select id="businessSelect" onchange="renderStock()"></select>
    <div id="stockTable"></div>
  </div>

  <div id="searchTab" class="tab-content">
    <input type="text" id="searchInput" placeholder="Nháº­p MST hoáº·c sá»‘ HÄ..." />
    <div id="searchResults"></div>
  </div>

  <script>
    const businesses = {};   // MST -> { ten, invoices[], stock[] }
    const allInvoices = [];

    function showTab(id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[onclick*='${id}']`).classList.add('active');
      document.getElementById(id).classList.add('active');
      if (id === 'stockTab') updateBusinessSelect();
      if (id === 'summaryTab') renderBusinessList();
    }

    function updateBusinessSelect() {
      const sel = document.getElementById('businessSelect');
      sel.innerHTML = Object.values(businesses).map(b => `<option value="${b.mst}">${b.ten} (${b.mst})</option>`).join('');
      renderStock();
    }

    function renderBusinessList() {
      const searchKey = document.getElementById('searchHKD').value.toLowerCase();
      const div = document.getElementById('hkdList');
      div.innerHTML = '';
      Object.values(businesses)
        .filter(b => b.mst.toLowerCase().includes(searchKey))
        .forEach(b => {
          const total = b.stock.reduce((s, i) => s + (i.sl * i.dg), 0);
          const box = document.createElement('div');
          box.innerHTML = `
            <h4>${b.ten} (${b.mst})</h4>
            <p>Tá»•ng SL: ${b.stock.reduce((s, i) => s + i.sl, 0)} | Tá»•ng tiá»n: ${total.toLocaleString()}</p>
            <button onclick="deleteHKD('${b.mst}')">ğŸ—‘ï¸ XoÃ¡ toÃ n bá»™</button>
          `;
          div.appendChild(box);
        });
    }

    function deleteHKD(mst) {
      if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n xoÃ¡ toÃ n bá»™ dá»¯ liá»‡u cá»§a HKD nÃ y?')) {
        delete businesses[mst];
        renderBusinessList();
      }
    }

    document.getElementById('searchHKD').addEventListener('input', renderBusinessList);

    document.getElementById('zipInput').addEventListener('change', async (event) => {
      const files = event.target.files;
      const status = document.getElementById('status');
      status.textContent = 'â³ Äang xá»­ lÃ½...';

      for (const file of files) {
        if (!file.name.endsWith('.zip')) continue;
        const zip = await JSZip.loadAsync(file);

        for (const [filename, fileObj] of Object.entries(zip.files)) {
          if (!filename.endsWith('.html')) continue;
          const html = await fileObj.async('string');
          const invoice = parseInvoiceHTML(html);
          if (!invoice.mstMua || !invoice.mccqt) continue;

          const mccqtKey = `${invoice.mccqt}-${invoice.so}`;
          if (allInvoices.some(i => `${i.mccqt}-${i.so}` === mccqtKey)) {
            console.warn('âš ï¸ MCCQT trÃ¹ng:', mccqtKey);
            continue;
          }

          allInvoices.push(invoice);

          const mst = invoice.mstMua;
          if (!businesses[mst]) businesses[mst] = { ten: invoice.tenMua, mst, invoices: [], stock: [] };
          businesses[mst].invoices.push(invoice);
          businesses[mst].stock.push(...invoice.items);
        }
      }

      status.textContent = 'âœ… Xá»­ lÃ½ xong';
    });

    function parseInvoiceHTML(html) {
      const dom = new DOMParser().parseFromString(html, 'text/html');
      const get = sel => (dom.querySelector(sel)?.textContent.trim() || '');
      const invoice = {
        so: get(".code-content b:nth-child(3)"),
        kyHieu: get(".code-content b:nth-child(2)"),
        ngay: get("p.day"),
        mccqt: get("li:nth-child(2) .di-value div"),
        tenMua: get("li:nth-child(9) .di-value div"),
        mstMua: get("li:nth-child(11) .di-value div"),
        items: [],
        total: 0
      };

      const table = dom.querySelector('table.res-tb');
      if (table) {
        for (const row of table.querySelectorAll('tbody tr')) {
          const cells = [...row.querySelectorAll('td')].map(td => td.textContent.trim());
          if (cells.length >= 10) {
            const sl = parseFloat(cells[5].replace(/,/g, '')) || 0;
            const dg = parseFloat(cells[6].replace(/,/g, '')) || 0;
            const tt = parseFloat(cells[9].replace(/,/g, '')) || 0;
            invoice.items.push({ ten: cells[3], dvt: cells[4], sl, dg, tt });
            invoice.total += tt;
          }
        }
      }
      return invoice;
    }

    function renderStock() {
      const mst = document.getElementById('businessSelect').value;
      const container = document.getElementById('stockTable');
      container.innerHTML = '';
      if (!mst || !businesses[mst]) return;

      const table = document.createElement('table');
      table.innerHTML = `<thead><tr>
        <th>STT</th><th>TÃªn hÃ ng hÃ³a</th><th>ÄÆ¡n vá»‹</th><th>Sá»‘ lÆ°á»£ng</th><th>ÄÆ¡n giÃ¡</th><th>ThÃ nh tiá»n</th>
      </tr></thead>`;

      const tbody = document.createElement('tbody');
      businesses[mst].stock.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i + 1}</td><td>${item.ten}</td><td>${item.dvt}</td>
          <td>${item.sl}</td><td>${item.dg}</td><td>${(item.sl * item.dg).toLocaleString()}</td>`;
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }
  </script>
</body>
</html>
