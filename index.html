<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quáº£n lÃ½ Kinh doanh</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .section { margin-bottom: 30px; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    button, input[type="submit"] { padding: 8px 16px; margin: 5px; }
    input[type="text"], input[type="password"], input[type="number"] { padding: 8px; margin: 5px; }
    .manager-only { display: none; }
  </style>
</head>
<body>
  <!-- ÄÄƒng nháº­p -->
  <div id="login-section">
    <h2>ğŸ” ÄÄƒng nháº­p</h2>
    <input type="text" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Máº­t kháº©u">
    <label><input type="checkbox" id="remember-me"> Ghi nhá»› Ä‘Äƒng nháº­p</label>
    <button id="login-button">ÄÄƒng nháº­p</button>
  </div>

  <!-- Ná»™i dung chÃ­nh -->
  <div id="main-content" class="hidden">
    <h1>ğŸ“Š Quáº£n lÃ½ Kinh doanh</h1>
    <button id="logout-button">ÄÄƒng xuáº¥t</button>

    <!-- Chi phÃ­ -->
    <div class="section">
      <h2>ğŸ’¸ Chi phÃ­</h2>
      <input type="text" id="cost-description" placeholder="MÃ´ táº£">
      <input type="number" id="cost-amount" placeholder="Sá»‘ tiá»n">
      <button id="add-cost">ThÃªm</button>
      <table id="cost-table">
        <tr><th>MÃ´ táº£</th><th>Sá»‘ tiá»n</th><th>HÃ nh Ä‘á»™ng</th></tr>
      </table>
    </div>

    <!-- Xuáº¥t hÃ ng -->
    <div class="section">
      <h2>ğŸ“¦ Xuáº¥t hÃ ng</h2>
      <input type="text" id="export-product" placeholder="Sáº£n pháº©m">
      <input type="number" id="export-quantity" placeholder="Sá»‘ lÆ°á»£ng">
      <input type="text" id="export-unit" placeholder="ÄVT">
      <button id="add-export">ThÃªm xuáº¥t hÃ ng</button>
      <table id="export-table">
        <tr><th>Sáº£n pháº©m</th><th>Sá»‘ lÆ°á»£ng</th><th>ÄVT</th><th>HÃ nh Ä‘á»™ng</th></tr>
      </table>
    </div>

    <!-- Doanh thu -->
    <div class="section">
      <h2>ğŸ’° Doanh thu</h2>
      <input type="text" id="revenue-description" placeholder="MÃ´ táº£">
      <input type="number" id="revenue-amount" placeholder="Sá»‘ tiá»n">
      <button id="add-revenue">ThÃªm</button>
      <table id="revenue-table">
        <tr><th>MÃ´ táº£</th><th>Sá»‘ tiá»n</th><th>HÃ nh Ä‘á»™ng</th></tr>
      </table>
    </div>

    <!-- Tá»•ng káº¿t ngÃ y -->
    <div class="section">
      <h2>ğŸ“ Tá»•ng káº¿t ngÃ y</h2>
      <p>Doanh thu: <span id="total-revenue">0â‚«</span></p>
      <p>Tá»•ng chi phÃ­: <span id="total-cost">0â‚«</span></p>
      <p>Sá»‘ dÆ°: <span id="balance">0â‚«</span></p>
      <textarea id="personal-note" placeholder="Ghi chÃº cÃ¡ nhÃ¢n"></textarea>
      <button id="save-note">LÆ°u dá»¯ liá»‡u</button>
    </div>

    <!-- Quáº£n lÃ½ kho hÃ ng -->
    <div class="section">
      <h2>ğŸ“¦ Quáº£n lÃ½ Kho hÃ ng</h2>
      <input type="text" id="product-name" placeholder="TÃªn sáº£n pháº©m">
      <input type="number" id="product-quantity" placeholder="Sá»‘ lÆ°á»£ng">
      <input type="text" id="product-unit" placeholder="ÄVT">
      <input type="number" id="product-unit-price" placeholder="GiÃ¡ Ä‘Æ¡n vá»‹">
      <button id="add-product" class="manager-only">ThÃªm sáº£n pháº©m</button>
      <table id="inventory-table">
        <tr><th>TÃªn sáº£n pháº©m</th><th>Sá»‘ lÆ°á»£ng</th><th>ÄVT</th><th>GiÃ¡ Ä‘Æ¡n vá»‹</th><th>HÃ nh Ä‘á»™ng</th></tr>
      </table>
    </div>

    <!-- BÃ¡o cÃ¡o -->
    <div class="section">
      <h2>ğŸ“Š BÃ¡o cÃ¡o</h2>
      <button id="daily-report">BÃ¡o cÃ¡o ngÃ y</button>
      <button id="monthly-report">BÃ¡o cÃ¡o thÃ¡ng</button>
      <button id="print-report">In bÃ¡o cÃ¡o</button>
      <select id="user-filter">
        <option value="all">Táº¥t cáº£ ngÆ°á»i dÃ¹ng</option>
      </select>
      <select id="category-filter">
        <option value="costs">Chi phÃ­</option>
        <option value="revenues">Doanh thu</option>
        <option value="exports">Xuáº¥t hÃ ng</option>
      </select>
      <button id="apply-filter">Ãp dá»¥ng</button>
      <div id="report-result"></div>
    </div>

    <!-- Quáº£n lÃ½ ngÆ°á»i dÃ¹ng -->
    <div class="section manager-only" id="user-management">
      <h2>ğŸ‘¥ Quáº£n lÃ½ NgÆ°á»i dÃ¹ng</h2>
      <input type="text" id="username" placeholder="TÃªn Ä‘Äƒng nháº­p">
      <select id="role">
        <option value="employee">NhÃ¢n viÃªn</option>
        <option value="manager">Quáº£n lÃ½</option>
      </select>
      <input type="text" id="user-email" placeholder="Email">
      <input type="password" id="user-password" placeholder="Máº­t kháº©u">
      <button id="add-user">ThÃªm ngÆ°á»i dÃ¹ng</button>
      <table id="user-table">
        <tr><th>TÃªn Ä‘Äƒng nháº­p</th><th>Vai trÃ²</th><th>Tráº¡ng thÃ¡i</th><th>HÃ nh Ä‘á»™ng</th></tr>
      </table>
    </div>
  </div>

  <!-- Firebase SDK with type="module" -->
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, getDoc, doc, updateDoc, deleteDoc, runTransaction, Timestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDmFpKa8TpDjo3pQADaTubgVpDPOi-FPXk",
      authDomain: "quanly-d7e54.firebaseapp.com",
      projectId: "quanly-d7e54",
      storageBucket: "quanly-d7e54.firebasestorage.app",
      messagingSenderId: "482686011267",
      appId: "1:482686011267:web:f2fe9d400fe618487a98b6",
      measurementId: "G-G3H6MTCWCM"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Xá»­ lÃ½ Ä‘Äƒng nháº­p/Ä‘Äƒng xuáº¥t
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        loadUserData(user.uid);
      } else {
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('main-content').classList.add('hidden');
      }
    });

    document.getElementById('login-button').addEventListener('click', () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => console.log('ÄÄƒng nháº­p thÃ nh cÃ´ng'))
        .catch((error) => alert('Lá»—i Ä‘Äƒng nháº­p: ' + error.message));
    });

    document.getElementById('logout-button').addEventListener('click', () => {
      signOut(auth).then(() => console.log('ÄÄƒng xuáº¥t thÃ nh cÃ´ng'));
    });

    // Táº£i dá»¯ liá»‡u ngÆ°á»i dÃ¹ng vÃ  phÃ¢n quyá»n
    async function loadUserData(uid) {
      const userDoc = await getDoc(doc(db, 'users', uid));
      if (userDoc.exists() && userDoc.data().role === 'manager') {
        document.querySelectorAll('.manager-only').forEach(el => el.style.display = 'block');
      }
      loadUsers(); // Cáº­p nháº­t danh sÃ¡ch ngÆ°á»i dÃ¹ng cho select filter
    }

    // Chi phÃ­
    document.getElementById('add-cost').addEventListener('click', async () => {
      const description = document.getElementById('cost-description').value;
      const amount = document.getElementById('cost-amount').value;
      if (description && amount) {
        try {
          await addDoc(collection(db, 'costs'), {
            description: description,
            amount: parseFloat(amount),
            createdBy: auth.currentUser.uid,
            timestamp: Timestamp.now()
          });
          document.getElementById('cost-description').value = '';
          document.getElementById('cost-amount').value = '';
        } catch (error) {
          alert('Lá»—i: ' + error.message);
        }
      }
    });

    onSnapshot(query(collection(db, 'costs'), orderBy('timestamp', 'desc')), (snapshot) => {
      const table = document.getElementById('cost-table');
      table.innerHTML = '<tr><th>MÃ´ táº£</th><th>Sá»‘ tiá»n</th><th>HÃ nh Ä‘á»™ng</th></tr>';
      snapshot.forEach((doc) => {
        const data = doc.data();
        const row = `<tr>
          <td>${data.description}</td>
          <td>${data.amount}</td>
          <td class="manager-only"><button onclick="deleteDoc('costs', '${doc.id}')">XÃ³a</button></td>
        </tr>`;
        table.innerHTML += row;
      });
    });

    // Xuáº¥t hÃ ng
    document.getElementById('add-export').addEventListener('click', async () => {
      const product = document.getElementById('export-product').value;
      const quantity = document.getElementById('export-quantity').value;
      const unit = document.getElementById('export-unit').value;
      if (product && quantity && unit) {
        try {
          await runTransaction(db, async (transaction) => {
            const inventoryRef = doc(db, 'inventory', product);
            const docSnap = await transaction.get(inventoryRef);
            if (!docSnap.exists()) throw new Error('Sáº£n pháº©m khÃ´ng tá»“n táº¡i!');
            const newQuantity = docSnap.data().quantity - parseInt(quantity);
            if (newQuantity < 0) throw new Error('Sá»‘ lÆ°á»£ng tá»“n kho khÃ´ng Ä‘á»§!');
            transaction.update(inventoryRef, { quantity: newQuantity });
            transaction.set(doc(collection(db, 'exports')), {
              product: product,
              quantity: parseInt(quantity),
              unit: unit,
              createdBy: auth.currentUser.uid,
              timestamp: Timestamp.now()
            });
          });
          document.getElementById('export-product').value = '';
          document.getElementById('export-quantity').value = '';
          document.getElementById('export-unit').value = '';
        } catch (error) {
          alert('Lá»—i: ' + error.message);
        }
      }
    });

    onSnapshot(query(collection(db, 'exports'), orderBy('timestamp', 'desc')), (snapshot) => {
      const table = document.getElementById('export-table');
      table.innerHTML = '<tr><th>Sáº£n pháº©m</th><th>Sá»‘ lÆ°á»£ng</th><th>ÄVT</th><th>HÃ nh Ä‘á»™ng</th></tr>';
      snapshot.forEach((doc) => {
        const data = doc.data();
        const row = `<tr>
          <td>${data.product}</td>
          <td>${data.quantity}</td>
          <td>${data.unit}</td>
          <td class="manager-only"><button onclick="deleteDoc('exports', '${doc.id}')">XÃ³a</button></td>
        </tr>`;
        table.innerHTML += row;
      });
    });

    // Doanh thu
    document.getElementById('add-revenue').addEventListener('click', async () => {
      const description = document.getElementById('revenue-description').value;
      const amount = document.getElementById('revenue-amount').value;
      if (description && amount) {
        try {
          await addDoc(collection(db, 'revenues'), {
            description: description,
            amount: parseFloat(amount),
            createdBy: auth.currentUser.uid,
            timestamp: Timestamp.now()
          });
          document.getElementById('revenue-description').value = '';
          document.getElementById('revenue-amount').value = '';
        } catch (error) {
          alert('Lá»—i: ' + error.message);
        }
      }
    });

    onSnapshot(query(collection(db, 'revenues'), orderBy('timestamp', 'desc')), (snapshot) => {
      const table = document.getElementById('revenue-table');
      table.innerHTML = '<tr><th>MÃ´ táº£</th><th>Sá»‘ tiá»n</th><th>HÃ nh Ä‘á»™ng</th></tr>';
      snapshot.forEach((doc) => {
        const data = doc.data();
        const row = `<tr>
          <td>${data.description}</td>
          <td>${data.amount}</td>
          <td class="manager-only"><button onclick="deleteDoc('revenues', '${doc.id}')">XÃ³a</button></td>
        </tr>`;
        table.innerHTML += row;
      });
    });

    // Tá»•ng káº¿t ngÃ y
    async function updateDailySummary() {
      const startOfDay = new Date(new Date().setHours(0, 0, 0, 0));
      const endOfDay = new Date(new Date().setHours(23, 59, 59, 999));
      let totalRevenue = 0;
      let totalCost = 0;

      const revenueSnapshot = await getDocs(query(
        collection(db, 'revenues'),
        where('timestamp', '>=', Timestamp.fromDate(startOfDay)),
        where('timestamp', '<=', Timestamp.fromDate(endOfDay))
      ));
      revenueSnapshot.forEach((doc) => totalRevenue += doc.data().amount);
      document.getElementById('total-revenue').textContent = `${totalRevenue}â‚«`;

      const costSnapshot = await getDocs(query(
        collection(db, 'costs'),
        where('timestamp', '>=', Timestamp.fromDate(startOfDay)),
        where('timestamp', '<=', Timestamp.fromDate(endOfDay))
      ));
      costSnapshot.forEach((doc) => totalCost += doc.data().amount);
      document.getElementById('total-cost').textContent = `${totalCost}â‚«`;

      document.getElementById('balance').textContent = `${totalRevenue - totalCost}â‚«`;
    }

    document.getElementById('save-note').addEventListener('click', async () => {
      const note = document.getElementById('personal-note').value;
      if (note) {
        try {
          await addDoc(collection(db, 'daily_notes'), {
            note: note,
            createdBy: auth.currentUser.uid,
            timestamp: Timestamp.now()
          });
          document.getElementById('personal-note').value = '';
        } catch (error) {
          alert('Lá»—i: ' + error.message);
        }
      }
    });

    // Quáº£n lÃ½ kho hÃ ng
    document.getElementById('add-product').addEventListener('click', async () => {
      const product = document.getElementById('product-name').value;
      const quantity = document.getElementById('product-quantity').value;
      const unit = document.getElementById('product-unit').value;
      const unitPrice = document.getElementById('product-unit-price').value;
      if (product && quantity && unit && unitPrice) {
        try {
          await setDoc(doc(db, 'inventory', product), {
            product: product,
            quantity: parseInt(quantity),
            unit: unit,
            unitPrice: parseFloat(unitPrice)
          });
          document.getElementById('product-name').value = '';
          document.getElementById('product-quantity').value = '';
          document.getElementById('product-unit').value = '';
          document.getElementById('product-unit-price').value = '';
        } catch (error) {
          alert('Lá»—i: ' + error.message);
        }
      }
    });

    onSnapshot(collection(db, 'inventory'), (snapshot) => {
      const table = document.getElementById('inventory-table');
      table.innerHTML = '<tr><th>TÃªn sáº£n pháº©m</th><th>Sá»‘ lÆ°á»£ng</th><th>ÄVT</th><th>GiÃ¡ Ä‘Æ¡n vá»‹</th><th>HÃ nh Ä‘á»™ng</th></tr>';
      snapshot.forEach((doc) => {
        const data = doc.data();
        const row = `<tr>
          <td>${data.product}</td>
          <td>${data.quantity}</td>
          <td>${data.unit}</td>
          <td>${data.unitPrice}</td>
          <td class="manager-only"><button onclick="deleteDoc('inventory', '${doc.id}')">XÃ³a</button></td>
        </tr>`;
        table.innerHTML += row;
      });
    });

    // BÃ¡o cÃ¡o
    document.getElementById('daily-report').addEventListener('click', () => {
      const startOfDay = new Date(new Date().setHours(0, 0, 0, 0));
      const endOfDay = new Date(new Date().setHours(23, 59, 59, 999));
      generateReport('daily', startOfDay, endOfDay);
    });

    document.getElementById('monthly-report').addEventListener('click', () => {
      const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
      const endOfMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0, 23, 59, 59, 999);
      generateReport('monthly', startOfMonth, endOfMonth);
    });

    async function generateReport(type, start, end) {
      const category = document.getElementById('category-filter').value;
      const user = document.getElementById('user-filter').value;
      let q = query(
        collection(db, category),
        where('timestamp', '>=', Timestamp.fromDate(start)),
        where('timestamp', '<=', Timestamp.fromDate(end))
      );
      if (user !== 'all') q = query(q, where('createdBy', '==', user));
      const snapshot = await getDocs(q);
      let report = `BÃ¡o cÃ¡o ${type === 'daily' ? 'ngÃ y' : 'thÃ¡ng'} (${category}):\n`;
      snapshot.forEach((doc) => {
        const data = doc.data();
        report += `${data.description || data.product}: ${data.amount || data.quantity} ${data.unit || 'â‚«'}\n`;
      });
      document.getElementById('report-result').textContent = report;
    }

    document.getElementById('print-report').addEventListener('click', () => {
      window.print();
    });

    // Quáº£n lÃ½ ngÆ°á»i dÃ¹ng
    async function loadUsers() {
      onSnapshot(collection(db, 'users'), (snapshot) => {
        const table = document.getElementById('user-table');
        const userFilter = document.getElementById('user-filter');
        table.innerHTML = '<tr><th>TÃªn Ä‘Äƒng nháº­p</th><th>Vai trÃ²</th><th>Tráº¡ng thÃ¡i</th><th>HÃ nh Ä‘á»™ng</th></tr>';
        userFilter.innerHTML = '<option value="all">Táº¥t cáº£ ngÆ°á»i dÃ¹ng</option>';
        snapshot.forEach((doc) => {
          const data = doc.data();
          const row = `<tr>
            <td>${data.username}</td>
            <td>${data.role}</td>
            <td>${data.status}</td>
            <td class="manager-only"><button onclick="deleteDoc('users', '${doc.id}')">XÃ³a</button></td>
          </tr>`;
          table.innerHTML += row;
          userFilter.innerHTML += `<option value="${doc.id}">${data.username}</option>`;
        });
      });
    }

    document.getElementById('add-user').addEventListener('click', async () => {
      const username = document.getElementById('username').value;
      const role = document.getElementById('role').value;
      const email = document.getElementById('user-email').value;
      const password = document.getElementById('user-password').value;
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'users', userCredential.user.uid), {
          username: username,
          role: role,
          status: 'active'
        });
        document.getElementById('username').value = '';
        document.getElementById('role').value = 'employee';
        document.getElementById('user-email').value = '';
        document.getElementById('user-password').value = '';
      } catch (error) {
        alert('Lá»—i: ' + error.message);
      }
    });

    // HÃ m xÃ³a tÃ i liá»‡u
    window.deleteDoc = async function(collection, docId) {
      try {
        await deleteDoc(doc(db, collection, docId));
        console.log('XÃ³a thÃ nh cÃ´ng');
      } catch (error) {
        alert('Lá»—i: ' + error.message);
      }
    };

    // Cáº­p nháº­t tá»•ng káº¿t ngÃ y khi táº£i trang
    updateDailySummary();
  </script>
</body>
</html>
