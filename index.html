<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Äá»c hÃ³a Ä‘Æ¡n tá»« ZIP vÃ  tÃ­nh tá»•ng Ä‘Ãºng</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>
<body>
  <h2>ğŸ“¦ Äá»c hÃ³a Ä‘Æ¡n XML trong file ZIP vÃ  tÃ­nh tá»•ng thá»§ cÃ´ng</h2>
  <input type="file" id="zipFileInput" accept=".zip" />
  <div id="output"></div>

  <script>
    document.getElementById('zipFileInput').addEventListener('change', async function(event) {
      const file = event.target.files[0];
      if (!file) return;
      await handleZipFileInput(file);
    });

    async function handleZipFileInput(file) {
      try {
        const zip = await JSZip.loadAsync(file);
        const xmlText = await extractXmlFromZip(zip);
        if (!xmlText) return alert("âŒ KhÃ´ng tÃ¬m tháº¥y file XML trong ZIP.");

        const { items, xmlDoc } = parseInvoiceFromXml(xmlText);
        const totals = calculateTotals(items, xmlDoc);
        renderResult(items, totals);
      } catch (error) {
        console.error(error);
        alert("âŒ Lá»—i xá»­ lÃ½ file ZIP hoáº·c XML.");
      }
    }

    async function extractXmlFromZip(zip) {
      const xmlFile = Object.values(zip.files).find(f => f.name.endsWith('.xml'));
      if (!xmlFile) return null;
      return await xmlFile.async("text");
    }

    function parseInvoiceFromXml(xmlText) {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, "application/xml");
      const items = Array.from(xmlDoc.querySelectorAll("HHDVu")).map(item => {
        const tchat = parseInt(item.querySelector("TChat")?.textContent || '1');
        let thanhtien = parseFloat(item.querySelector("ThTien")?.textContent || '0');
        if (tchat === 3) thanhtien *= -1;

        return {
          stt: item.querySelector("STT")?.textContent || '',
          ten: item.querySelector("THHDVu")?.textContent || '',
          dvt: item.querySelector("DVTinh")?.textContent || '',
          sl: item.querySelector("SLuong")?.textContent || '0',
          dg: item.querySelector("DGia")?.textContent || '0',
          ck: item.querySelector("STCKhau")?.textContent || '0',
          tchat,
          thanhtien,
          thue: item.querySelector("TSuat")?.textContent || ''
        };
      });

      return { items, xmlDoc };
    }

    function calculateTotals(items, xmlDoc) {
      const totalManual = items.reduce((sum, item) => sum + item.thanhtien, 0);
      const tgTThue = parseFloat(xmlDoc.querySelector("TgTThue")?.textContent || '0');
      const ttCKTMai = parseFloat(xmlDoc.querySelector("TTCKTMai")?.textContent || '0');
      const tgTTTBSo = parseFloat(xmlDoc.querySelector("TgTTTBSo")?.textContent || '0');
      const totalFinal = totalManual + tgTThue;

      return {
        totalManual,
        tgTThue,
        ttCKTMai,
        tgTTTBSo,
        totalFinal
      };
    }

    function renderResult(items, totals) {
      const tableRows = items.map(item => `
        <tr>
          <td>${item.stt}</td>
          <td>${item.ten}</td>
          <td>${item.dvt}</td>
          <td>${item.sl}</td>
          <td>${Number(item.dg).toLocaleString()}</td>
          <td>${Number(item.ck).toLocaleString()}</td>
          <td style="text-align:right">${item.thanhtien.toLocaleString()}</td>
          <td>${item.thue}</td>
        </tr>
      `);

      const khop = Math.abs(totals.totalFinal - totals.tgTTTBSo) < 1;

      document.getElementById("output").innerHTML = `
        <h3>ğŸ“‘ Báº£ng kÃª hÃ ng hÃ³a</h3>
        <table border="1" cellpadding="6" cellspacing="0">
          <thead>
            <tr>
              <th>STT</th><th>TÃªn hÃ ng hÃ³a</th><th>ÄVT</th><th>SL</th>
              <th>ÄÆ¡n giÃ¡</th><th>Chiáº¿t kháº¥u</th><th>ThÃ nh tiá»n</th><th>Thuáº¿ suáº¥t</th>
            </tr>
          </thead>
          <tbody>${tableRows.join('')}</tbody>
        </table>
        <br/>
        <h3>ğŸ§® TÃ­nh toÃ¡n tá»•ng</h3>
        <ul>
          <li><b>Tá»•ng tiá»n hÃ ng hÃ³a (tá»± cá»™ng & cÃ³ chiáº¿t kháº¥u Ã¢m):</b> ${totals.totalManual.toLocaleString()} VND</li>
          <li><b>Thuáº¿ GTGT (tá»« XML TgTThue):</b> ${totals.tgTThue.toLocaleString()} VND</li>
          <li><b>Chiáº¿t kháº¥u TM (TTCKTMai â€“ chá»‰ tham kháº£o, KHÃ”NG trá»«):</b> ${totals.ttCKTMai.toLocaleString()} VND</li>
          <li><b><u>Tá»•ng thanh toÃ¡n (tÃ­nh tay):</u></b> <strong>${totals.totalFinal.toLocaleString()} VND</strong></li>
          <li><b>Tá»•ng trÃªn XML TgTTTBSo:</b> ${totals.tgTTTBSo.toLocaleString()} VND</li>
          <li><b>âœ… ${khop ? 'KHá»šP' : 'KHÃ”NG KHá»šP'} vá»›i sá»‘ tá»•ng trÃªn hÃ³a Ä‘Æ¡n</b></li>
        </ul>
      `;
    }
  </script>
</body>
</html>