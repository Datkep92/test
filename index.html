<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Đọc hóa đơn từ ZIP và tính tổng đúng</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
</head>
<body>
  <h2>📦 Đọc hóa đơn XML trong file ZIP và tính tổng thủ công</h2>
  <input type="file" id="zipFileInput" accept=".zip" />
  <div id="output"></div>

  <script>
    document.getElementById('zipFileInput').addEventListener('change', async function(event) {
      const file = event.target.files[0];
      if (!file) return;
      await handleZipFileInput(file);
    });

    async function handleZipFileInput(file) {
      try {
        const zip = await JSZip.loadAsync(file);
        const xmlText = await extractXmlFromZip(zip);
        if (!xmlText) return alert("❌ Không tìm thấy file XML trong ZIP.");

        const { items, xmlDoc } = parseInvoiceFromXml(xmlText);
        const totals = calculateTotals(items, xmlDoc);
        renderResult(items, totals);
      } catch (error) {
        console.error(error);
        alert("❌ Lỗi xử lý file ZIP hoặc XML.");
      }
    }

    async function extractXmlFromZip(zip) {
      const xmlFile = Object.values(zip.files).find(f => f.name.endsWith('.xml'));
      if (!xmlFile) return null;
      return await xmlFile.async("text");
    }

    function parseInvoiceFromXml(xmlText) {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, "application/xml");
      const items = Array.from(xmlDoc.querySelectorAll("HHDVu")).map(item => {
        const tchat = parseInt(item.querySelector("TChat")?.textContent || '1');
        let thanhtien = parseFloat(item.querySelector("ThTien")?.textContent || '0');
        if (tchat === 3) thanhtien *= -1;

        return {
          stt: item.querySelector("STT")?.textContent || '',
          ten: item.querySelector("THHDVu")?.textContent || '',
          dvt: item.querySelector("DVTinh")?.textContent || '',
          sl: item.querySelector("SLuong")?.textContent || '0',
          dg: item.querySelector("DGia")?.textContent || '0',
          ck: item.querySelector("STCKhau")?.textContent || '0',
          tchat,
          thanhtien,
          thue: item.querySelector("TSuat")?.textContent || ''
        };
      });

      return { items, xmlDoc };
    }

    function calculateTotals(items, xmlDoc) {
      const totalManual = items.reduce((sum, item) => sum + item.thanhtien, 0);
      const tgTThue = parseFloat(xmlDoc.querySelector("TgTThue")?.textContent || '0');
      const ttCKTMai = parseFloat(xmlDoc.querySelector("TTCKTMai")?.textContent || '0');
      const tgTTTBSo = parseFloat(xmlDoc.querySelector("TgTTTBSo")?.textContent || '0');
      const totalFinal = totalManual + tgTThue;

      return {
        totalManual,
        tgTThue,
        ttCKTMai,
        tgTTTBSo,
        totalFinal
      };
    }

    function renderResult(items, totals) {
      const tableRows = items.map(item => `
        <tr>
          <td>${item.stt}</td>
          <td>${item.ten}</td>
          <td>${item.dvt}</td>
          <td>${item.sl}</td>
          <td>${Number(item.dg).toLocaleString()}</td>
          <td>${Number(item.ck).toLocaleString()}</td>
          <td style="text-align:right">${item.thanhtien.toLocaleString()}</td>
          <td>${item.thue}</td>
        </tr>
      `);

      const khop = Math.abs(totals.totalFinal - totals.tgTTTBSo) < 1;

      document.getElementById("output").innerHTML = `
        <h3>📑 Bảng kê hàng hóa</h3>
        <table border="1" cellpadding="6" cellspacing="0">
          <thead>
            <tr>
              <th>STT</th><th>Tên hàng hóa</th><th>ĐVT</th><th>SL</th>
              <th>Đơn giá</th><th>Chiết khấu</th><th>Thành tiền</th><th>Thuế suất</th>
            </tr>
          </thead>
          <tbody>${tableRows.join('')}</tbody>
        </table>
        <br/>
        <h3>🧮 Tính toán tổng</h3>
        <ul>
          <li><b>Tổng tiền hàng hóa (tự cộng & có chiết khấu âm):</b> ${totals.totalManual.toLocaleString()} VND</li>
          <li><b>Thuế GTGT (từ XML TgTThue):</b> ${totals.tgTThue.toLocaleString()} VND</li>
          <li><b>Chiết khấu TM (TTCKTMai – chỉ tham khảo, KHÔNG trừ):</b> ${totals.ttCKTMai.toLocaleString()} VND</li>
          <li><b><u>Tổng thanh toán (tính tay):</u></b> <strong>${totals.totalFinal.toLocaleString()} VND</strong></li>
          <li><b>Tổng trên XML TgTTTBSo:</b> ${totals.tgTTTBSo.toLocaleString()} VND</li>
          <li><b>✅ ${khop ? 'KHỚP' : 'KHÔNG KHỚP'} với số tổng trên hóa đơn</b></li>
        </ul>
      `;
    }
  </script>
</body>
</html>