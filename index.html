<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω Kinh doanh</title>
  <style>
    /* Reset CSS */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
    }
    
    body {
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }
    
    /* Layout */
    .container {
      padding: 15px;
      max-width: 100%;
    }
    
    header {
      background: #2c3e50;
      color: #fff;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .login-box {
      max-width: 100%;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    .section {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    /* Form elements */
    input, button, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    
    button {
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    button:hover {
      background: #2980b9;
    }
    
    button.danger {
      background: #e74c3c;
    }
    
    button.success {
      background: #2ecc71;
    }
    
    button.warning {
      background: #f39c12;
    }
    
    /* Tables */
    .table-responsive {
      overflow-x: auto;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
      min-width: 600px;
    }
    
    .table th, .table td {
      padding: 12px;
      border: 1px solid #eee;
      text-align: left;
    }
    
    .table th {
      background: #f8f9fa;
      font-weight: 600;
    }
    
    /* Tabs */
    .tab-container {
      display: flex;
      overflow-x: auto;
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
      -webkit-overflow-scrolling: touch;
    }
    
    .tab {
      padding: 10px 15px;
      cursor: pointer;
      background: #f1f1f1;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
      white-space: nowrap;
    }
    
    .tab.active {
      background: #3498db;
      color: white;
    }
    
    /* Product grid */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    /* Utility classes */
    .hidden {
      display: none;
    }
    
    .text-right {
      text-align: right;
    }
    
    .text-center {
      text-align: center;
    }
    
    .error-message {
      color: #e74c3c;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }
    
    .category-badge {
      display: inline-block;
      padding: 3px 8px;
      background: #e1f0ff;
      border-radius: 10px;
      font-size: 12px;
      margin-left: 5px;
    }
    
    /* Responsive adjustments */
    @media (min-width: 768px) {
      .container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .flex-md {
        display: flex;
        gap: 15px;
      }
      
      .flex-md > * {
        flex: 1;
      }
    }
    
    /* Print styles */
    @media print {
      body * {
        visibility: hidden;
      }
      #reportOutput, #reportOutput * {
        visibility: visible;
      }
      #reportOutput {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header id="appHeader" class="hidden">
    <h1>üìä Qu·∫£n l√Ω Kinh doanh</h1>
    <div class="user-info">
      <span id="currentUser"></span>
      <button onclick="handleLogout()" class="logout-btn danger">ƒêƒÉng xu·∫•t</button>
    </div>
  </header>
  
  <!-- Login Screen -->
  <div class="container">
    <div class="login-box" id="loginBox">
      <h3 class="text-center">üîê ƒêƒÉng nh·∫≠p</h3>
      <div id="errorContainer"></div>
      <input type="text" id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p" autocomplete="username" />
      <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" autocomplete="current-password" />
      <label>
        <input type="checkbox" id="rememberMe" checked /> Ghi nh·ªõ ƒëƒÉng nh·∫≠p
      </label>
      <button onclick="handleLogin()" class="success">ƒêƒÉng nh·∫≠p</button>
    </div>
  </div>

  <!-- Sale Screen -->
  <div class="container hidden" id="saleApp">
    <div class="tab-container">
      <div class="tab active" onclick="switchTab('expense')">Chi ph√≠</div>
      <div class="tab" onclick="switchTab('export')">Xu·∫•t h√†ng</div>
      <div class="tab" onclick="switchTab('revenue')">Doanh thu</div>
    </div>
    
    <!-- Expense Tab -->
    <div class="section" id="expenseTab">
      <h3>üí∏ Chi ph√≠</h3>
      <div class="flex-md">
        <input type="text" id="expenseInput" placeholder="VD: mua xƒÉng 60000" />
        <button onclick="addExpense()">Th√™m</button>
      </div>
      <div class="table-responsive">
        <table class="table" id="expenseTable">
          <thead>
            <tr><th>M√¥ t·∫£</th><th class="text-right">S·ªë ti·ªÅn</th><th>H√†nh ƒë·ªông</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <!-- Export Tab -->
    <div class="section hidden" id="exportTab">
      <h3>üì¶ Xu·∫•t h√†ng</h3>
      <div id="productList" class="product-grid"></div>
      <div class="flex-md" style="margin-top: 15px;">
        <input type="number" id="exportQuantity" placeholder="S·ªë l∆∞·ª£ng" value="1" min="1" />
        <button onclick="addExport()" class="success">Th√™m xu·∫•t h√†ng</button>
      </div>
      <div class="table-responsive">
        <table class="table" id="exportTable">
          <thead>
            <tr><th>S·∫£n ph·∫©m</th><th>S·ªë l∆∞·ª£ng</th><th>ƒêVT</th><th>H√†nh ƒë·ªông</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <!-- Revenue Tab -->
    <div class="section hidden" id="revenueTab">
      <h3>üí∞ Doanh thu</h3>
      <div class="flex-md">
        <input type="text" id="revenueAmount" placeholder="S·ªë ti·ªÅn (VD: 500000)" />
        <button onclick="addRevenue()">Th√™m</button>
      </div>
    </div>
    
    <!-- Daily Summary -->
    <div class="section">
      <h3>üìù T·ªïng k·∫øt ng√†y <span id="summaryDate"></span></h3>
      <div class="table-responsive">
        <table class="table">
          <tr>
            <td>Doanh thu:</td>
            <td class="text-right" id="totalRevenue">0‚Ç´</td>
          </tr>
          <tr>
            <td>T·ªïng chi ph√≠:</td>
            <td class="text-right" id="totalExpense">0‚Ç´</td>
          </tr>
          <tr>
            <td><strong>S·ªë d∆∞:</strong></td>
            <td class="text-right" id="dailyBalance"><strong>0‚Ç´</strong></td>
          </tr>
        </table>
      </div>
      
      <div id="exportSummary"></div>
      
      <h4>Ghi ch√∫ c√° nh√¢n:</h4>
      <textarea id="dailyNote" class="note-input" placeholder="Nh·∫≠p ghi ch√∫ trong ng√†y..."></textarea>
      <button onclick="saveDailyData()" class="success">L∆∞u d·ªØ li·ªáu</button>
    </div>
  </div>

  <!-- Admin Screen -->
  <div class="container hidden" id="adminApp">
    <div class="section">
      <h3>üì¶ Qu·∫£n l√Ω Kho h√†ng</h3>
      <div class="flex-md">
        <input type="text" id="productName" placeholder="T√™n s·∫£n ph·∫©m" />
        <input type="number" id="productQuantity" placeholder="S·ªë l∆∞·ª£ng" min="0" />
        <input type="text" id="productUnit" placeholder="ƒêVT (kg, ly, chai...)" />
        <input type="number" id="productPrice" placeholder="Gi√° ƒë∆°n v·ªã (VNƒê)" min="0" />
        <button onclick="addProduct()">Th√™m s·∫£n ph·∫©m</button>
      </div>
      <div class="table-responsive">
        <table class="table" id="productTable">
          <thead>
            <tr><th>T√™n s·∫£n ph·∫©m</th><th>S·ªë l∆∞·ª£ng</th><th>ƒêVT</th><th class="text-right">Gi√° ƒë∆°n v·ªã</th><th>H√†nh ƒë·ªông</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <div class="section">
      <h3>üìä B√°o c√°o</h3>
      <div class="flex-md">
        <input type="date" id="reportDate" />
        <button onclick="generateDailyReport()">B√°o c√°o ng√†y</button>
        <button onclick="generateMonthlyReport()">B√°o c√°o th√°ng</button>
        <button onclick="printReport()" class="warning">In b√°o c√°o</button>
      </div>
      
      <div id="reportFilters" style="margin-top: 15px;">
        <div class="flex-md">
          <select id="reportUserFilter">
            <option value="all">T·∫•t c·∫£ ng∆∞·ªùi d√πng</option>
          </select>
          <select id="reportCategoryFilter">
            <option value="all">T·∫•t c·∫£ danh m·ª•c</option>
          </select>
          <button onclick="applyReportFilters()">√Åp d·ª•ng</button>
        </div>
      </div>
      
      <div id="reportOutput" style="margin-top: 20px;"></div>
    </div>
    
    <div class="section">
      <h3>üë• Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h3>
      <div class="flex-md">
        <input type="text" id="newUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" />
        <input type="password" id="newPassword" placeholder="M·∫≠t kh·∫©u" />
        <select id="newUserRole">
          <option value="staff">Nh√¢n vi√™n</option>
          <option value="admin">Qu·∫£n l√Ω</option>
        </select>
        <button onclick="addUser()" class="success">Th√™m ng∆∞·ªùi d√πng</button>
      </div>
      
      <div class="table-responsive">
        <table class="table" id="userTable" style="margin-top: 15px;">
          <thead>
            <tr><th>T√™n ƒëƒÉng nh·∫≠p</th><th>Vai tr√≤</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // System Data
    let users = JSON.parse(localStorage.getItem('users')) || {
      admin: { password: '123123', role: 'admin', active: true },
      test: { password: '1234', role: 'staff', active: true }
    };
    
    // Business Data
    let products = JSON.parse(localStorage.getItem('products')) || [];
    let expenseCategories = JSON.parse(localStorage.getItem('expenseCategories')) || [];
    let dailyData = {
      date: '',
      expenses: [],
      exports: [],
      revenue: 0,
      note: '',
      user: ''
    };
    
    let currentUser = null;
    let currentTab = 'expense';
    let selectedProduct = null;

    // Initialize the app
    function initApp() {
      // Set current date in report date picker
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('reportDate').value = today;
      
      // Load remembered user
      const rememberedUser = localStorage.getItem('rememberedUser');
      if (rememberedUser) {
        document.getElementById('username').value = rememberedUser;
        document.getElementById('password').focus();
      }
      
      // Event listeners
      document.getElementById('password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleLogin();
      });
      
      document.getElementById('expenseInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') addExpense();
      });
      
      document.getElementById('revenueAmount').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') addRevenue();
      });
      
      // Load data if already logged in
      if (localStorage.getItem('currentUser')) {
        currentUser = localStorage.getItem('currentUser');
        handleSuccessfulLogin();
      }
    }
    
    // Login functions
    function handleLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const rememberMe = document.getElementById('rememberMe').checked;
      
      // Clear previous errors
      document.getElementById('errorContainer').innerHTML = '';
      
      if (!username || !password) {
        showError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin ƒëƒÉng nh·∫≠p');
        return;
      }
      
      if (!users[username]) {
        showError('Sai t√™n ƒëƒÉng nh·∫≠p');
        return;
      }
      
      if (users[username].password !== password) {
        showError('Sai m·∫≠t kh·∫©u');
        return;
      }
      
      if (!users[username].active) {
        showError('T√†i kho·∫£n ƒë√£ b·ªã kh√≥a');
        return;
      }
      
      // Successful login
      if (rememberMe) {
        localStorage.setItem('rememberedUser', username);
      } else {
        localStorage.removeItem('rememberedUser');
      }
      
      currentUser = username;
      localStorage.setItem('currentUser', username);
      handleSuccessfulLogin();
    }
    
    function handleSuccessfulLogin() {
      document.getElementById('loginBox').classList.add('hidden');
      document.getElementById('appHeader').classList.remove('hidden');
      document.getElementById('currentUser').textContent = currentUser;
      
      if (users[currentUser].role === 'admin') {
        document.getElementById('adminApp').classList.remove('hidden');
        renderUserList();
        loadReportFilters();
      } else {
        document.getElementById('saleApp').classList.remove('hidden');
      }
      
      loadData();
    }
    
    function handleLogout() {
      currentUser = null;
      localStorage.removeItem('currentUser');
      document.getElementById('loginBox').classList.remove('hidden');
      document.getElementById('appHeader').classList.add('hidden');
      document.getElementById('adminApp').classList.add('hidden');
      document.getElementById('saleApp').classList.add('hidden');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    }
    
    function showError(message) {
      const errorContainer = document.getElementById('errorContainer');
      errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
    }
    
    // Data functions
    function loadData() {
      // Load products
      const savedProducts = localStorage.getItem('products');
      if (savedProducts) {
        products = JSON.parse(savedProducts);
        renderProducts();
      }
      
      // Load expense categories
      const savedCategories = localStorage.getItem('expenseCategories');
      if (savedCategories) {
        expenseCategories = JSON.parse(savedCategories);
      }
      
      // Load today's data
      const today = new Date().toLocaleDateString('vi-VN');
      const savedDailyData = localStorage.getItem(`dailyData_${today}_${currentUser}`);
      if (savedDailyData) {
        dailyData = JSON.parse(savedDailyData);
      } else {
        dailyData = {
          date: today,
          expenses: [],
          exports: [],
          revenue: 0,
          note: '',
          user: currentUser
        };
      }
      
      document.getElementById('summaryDate').textContent = today;
      document.getElementById('currentDate').textContent = today;
      document.getElementById('dailyNote').value = dailyData.note || '';
      
      renderDailyData();
    }
    
    function saveData() {
      localStorage.setItem('products', JSON.stringify(products));
      localStorage.setItem('expenseCategories', JSON.stringify(expenseCategories));
    }
    
    function saveDailyData() {
      dailyData.note = document.getElementById('dailyNote').value;
      localStorage.setItem(`dailyData_${dailyData.date}_${currentUser}`, JSON.stringify(dailyData));
      alert('ƒê√£ l∆∞u d·ªØ li·ªáu ng√†y ' + dailyData.date);
    }
    
    // Sale functions
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
      
      document.getElementById('expenseTab').classList.add('hidden');
      document.getElementById('exportTab').classList.add('hidden');
      document.getElementById('revenueTab').classList.add('hidden');
      
      document.getElementById(`${tab}Tab`).classList.remove('hidden');
      
      if (tab === 'export') {
        renderProductSelection();
      }
    }
    
    function parseExpenseInput(input) {
      const normalized = input.toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9\s]/g, "");
      
      const amountMatch = normalized.match(/(\d+)\s*$/);
      const amount = amountMatch ? parseInt(amountMatch[1]) : 0;
      
      let description = normalized;
      if (amountMatch) {
        description = normalized.substring(0, amountMatch.index).trim();
      }
      
      const categoryMatch = description.match(/^\s*(\S+)/);
      const category = categoryMatch ? categoryMatch[1] : 'kh√°c';
      
      // Add new category if not exists
      if (!expenseCategories.includes(category)) {
        expenseCategories.push(category);
        saveData();
      }
      
      return {
        description: capitalizeFirstLetter(description),
        amount: amount,
        category: capitalizeFirstLetter(category)
      };
    }
    
    function capitalizeFirstLetter(string) {
      return string.split(' ').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
    }
    
    function addExpense() {
      const input = document.getElementById('expenseInput').value.trim();
      if (!input) {
        showError('Vui l√≤ng nh·∫≠p th√¥ng tin chi ph√≠');
        return;
      }
      
      const { description, amount, category } = parseExpenseInput(input);
      
      if (!description || amount <= 0) {
        showError('Kh√¥ng th·ªÉ x√°c ƒë·ªãnh m√¥ t·∫£ ho·∫∑c s·ªë ti·ªÅn t·ª´ th√¥ng tin nh·∫≠p');
        return;
      }
      
      dailyData.expenses.push({
        description: `${description}`,
        amount: amount,
        category: category,
        user: currentUser,
        timestamp: new Date().getTime()
      });
      
      document.getElementById('expenseInput').value = '';
      renderDailyData();
    }
    
    function deleteExpense(index) {
      if (confirm('X√≥a chi ph√≠ n√†y?')) {
        dailyData.expenses.splice(index, 1);
        renderDailyData();
      }
    }
    
    function renderProductSelection() {
      const container = document.getElementById('productList');
      container.innerHTML = '';
      
      products.forEach((product) => {
        const productItem = document.createElement('div');
        productItem.className = 'product-item';
        productItem.innerHTML = `
          <div><strong>${product.name}</strong></div>
          <div>T·ªìn kho: ${product.quantity} ${product.unit}</div>
        `;
        
        productItem.addEventListener('click', () => {
          document.querySelectorAll('.product-item').forEach(item => {
            item.classList.remove('selected');
          });
          productItem.classList.add('selected');
          selectedProduct = product;
        });
        
        container.appendChild(productItem);
      });
    }
    
    function addExport() {
      if (!selectedProduct) {
        showError('Vui l√≤ng ch·ªçn s·∫£n ph·∫©m');
        return;
      }
      
      const quantity = parseInt(document.getElementById('exportQuantity').value) || 1;
      
      if (quantity <= 0) {
        showError('S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0');
        return;
      }
      
      if (quantity > selectedProduct.quantity) {
        showError(`S·ªë l∆∞·ª£ng xu·∫•t v∆∞·ª£t qu√° t·ªìn kho (${selectedProduct.quantity} ${selectedProduct.unit})`);
        return;
      }
      
      // Check if product already exported today
      const existingExport = dailyData.exports.find(e => e.productId === selectedProduct.id);
      
      if (existingExport) {
        existingExport.quantity += quantity;
      } else {
        dailyData.exports.push({
          productId: selectedProduct.id,
          productName: selectedProduct.name,
          quantity: quantity,
          unit: selectedProduct.unit,
          price: selectedProduct.price,
          user: currentUser,
          timestamp: new Date().getTime()
        });
      }
      
      // Update product quantity
      selectedProduct.quantity -= quantity;
      saveData();
      
      document.getElementById('exportQuantity').value = '1';
      selectedProduct = null;
      document.querySelectorAll('.product-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      renderDailyData();
      renderProductSelection();
    }
    
    function deleteExport(index) {
      if (confirm('X√≥a xu·∫•t h√†ng n√†y?')) {
        const exportItem = dailyData.exports[index];
        
        // Return quantity to product
        const product = products.find(p => p.id === exportItem.productId);
        if (product) {
          product.quantity += exportItem.quantity;
          saveData();
        }
        
        dailyData.exports.splice(index, 1);
        renderDailyData();
        renderProductSelection();
      }
    }
    
    function addRevenue() {
      const amount = parseNumber(document.getElementById('revenueAmount').value);
      
      if (isNaN(amount)) {
        showError('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá');
        return;
      }
      
      dailyData.revenue += amount;
      document.getElementById('revenueAmount').value = '';
      renderDailyData();
    }
    
    function renderDailyData() {
      // Render expenses
      const expenseTable = document.querySelector('#expenseTable tbody');
      expenseTable.innerHTML = '';
      
      dailyData.expenses.forEach((expense, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${expense.description} <span class="category-badge">${expense.category}</span></td>
          <td class="text-right">${expense.amount.toLocaleString('vi-VN')}‚Ç´</td>
          <td class="actions">
            <button onclick="deleteExpense(${index})" class="danger">X√≥a</button>
          </td>
        `;
        expenseTable.appendChild(row);
      });
      
      // Render exports
      const exportTable = document.querySelector('#exportTable tbody');
      exportTable.innerHTML = '';
      
      dailyData.exports.forEach((exportItem, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${exportItem.productName}</td>
          <td>${exportItem.quantity}</td>
          <td>${exportItem.unit}</td>
          <td class="actions">
            <button onclick="deleteExport(${index})" class="danger">X√≥a</button>
          </td>
        `;
        exportTable.appendChild(row);
      });
      
      // Calculate and render summary
      const totalExpense = dailyData.expenses.reduce((sum, e) => sum + e.amount, 0);
      const totalExportCost = dailyData.exports.reduce((sum, e) => sum + (e.quantity * e.price), 0);
      const balance = dailyData.revenue - totalExpense;
      
      document.getElementById('totalRevenue').textContent = 
        dailyData.revenue.toLocaleString('vi-VN') + '‚Ç´';
      document.getElementById('totalExpense').textContent = 
        totalExpense.toLocaleString('vi-VN') + '‚Ç´';
      document.getElementById('dailyBalance').innerHTML = 
        `<strong>${balance.toLocaleString('vi-VN')}‚Ç´</strong>`;
      
      // Render export summary
      const exportSummary = document.getElementById('exportSummary');
      exportSummary.innerHTML = '';
      
      if (dailyData.exports.length > 0) {
        const summaryDiv = document.createElement('div');
        summaryDiv.style.marginTop = '15px';
        summaryDiv.innerHTML = `
          <h4>Xu·∫•t h√†ng h√¥m nay:</h4>
          <ul>
            ${dailyData.exports.map(e => 
              `<li>${e.productName}: ${e.quantity} ${e.unit}</li>`
            ).join('')}
          </ul>
        `;
        exportSummary.appendChild(summaryDiv);
      }
    }
    
    // Product management
    function addProduct() {
      const name = document.getElementById('productName').value.trim();
      const quantity = parseInt(document.getElementById('productQuantity').value) || 0;
      const unit = document.getElementById('productUnit').value.trim();
      const price = parseInt(document.getElementById('productPrice').value) || 0;
      
      if (!name || !unit || isNaN(quantity) || isNaN(price)) {
        showError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin s·∫£n ph·∫©m');
        return;
      }
      
      const newProduct = {
        id: Date.now().toString(),
        name: name,
        quantity: quantity,
        unit: unit,
        price: price
      };
      
      products.push(newProduct);
      saveData();
      
      // Clear inputs
      document.getElementById('productName').value = '';
      document.getElementById('productQuantity').value = '';
      document.getElementById('productUnit').value = '';
      document.getElementById('productPrice').value = '';
      
      renderProducts();
    }
    
    function editProduct(index) {
      const product = products[index];
      const newName = prompt('T√™n s·∫£n ph·∫©m:', product.name);
      if (!newName) return;
      
      const newQuantity = parseInt(prompt('S·ªë l∆∞·ª£ng:', product.quantity)) || 0;
      if (isNaN(newQuantity)) return alert('S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá');
      
      const newUnit = prompt('ƒê∆°n v·ªã t√≠nh:', product.unit);
      if (!newUnit) return;
      
      const newPrice = parseInt(prompt('Gi√° ƒë∆°n v·ªã:', product.price)) || 0;
      if (isNaN(newPrice)) return alert('Gi√° kh√¥ng h·ª£p l·ªá');
      
      product.name = newName;
      product.quantity = newQuantity;
      product.unit = newUnit;
      product.price = newPrice;
      
      saveData();
      renderProducts();
    }
    
    function deleteProduct(index) {
      if (confirm('X√≥a s·∫£n ph·∫©m n√†y?')) {
        products.splice(index, 1);
        saveData();
        renderProducts();
      }
    }
    
    function renderProducts() {
      const table = document.querySelector('#productTable tbody');
      table.innerHTML = '';
      
      products.forEach((product, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${product.name}</td>
          <td>${product.quantity}</td>
          <td>${product.unit}</td>
          <td class="text-right">${product.price.toLocaleString('vi-VN')}‚Ç´</td>
          <td class="actions">
            <button onclick="editProduct(${index})">S·ª≠a</button>
            <button onclick="deleteProduct(${index})" class="danger">X√≥a</button>
          </td>
        `;
        table.appendChild(row);
      });
    }
    
    // User management
    function addUser() {
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value.trim();
      const role = document.getElementById('newUserRole').value;
      
      if (!username || !password) {
        showError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u');
        return;
      }
      
      if (users[username]) {
        showError('T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i');
        return;
      }
      
      users[username] = {
        password: password,
        role: role,
        active: true
      };
      
      saveUsers();
      renderUserList();
      loadReportFilters();
      
      // Clear inputs
      document.getElementById('newUsername').value = '';
      document.getElementById('newPassword').value = '';
    }
    
    function toggleUserStatus(username) {
      if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ${users[username].active ? 'kh√≥a' : 'm·ªü kh√≥a'} t√†i kho·∫£n ${username}?`)) {
        users[username].active = !users[username].active;
        saveUsers();
        renderUserList();
      }
    }
    
    function deleteUser(username) {
      if (username === 'admin') {
        alert('Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n admin');
        return;
      }
      
      if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n ${username}?`)) {
        delete users[username];
        saveUsers();
        renderUserList();
        loadReportFilters();
      }
    }
    
    function saveUsers() {
      localStorage.setItem('users', JSON.stringify(users));
    }
    
    function renderUserList() {
      const table = document.querySelector('#userTable tbody');
      table.innerHTML = '';
      
      for (const username in users) {
        const user = users[username];
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${username}</td>
          <td>${user.role === 'admin' ? 'Qu·∫£n l√Ω' : 'Nh√¢n vi√™n'}</td>
          <td>${user.active ? 'ƒêang ho·∫°t ƒë·ªông' : 'ƒê√£ kh√≥a'}</td>
          <td class="actions">
            <button onclick="toggleUserStatus('${username}')" class="${user.active ? 'warning' : 'success'}">
              ${user.active ? 'Kh√≥a' : 'M·ªü kh√≥a'}
            </button>
            ${username !== 'admin' ? `
              <button onclick="deleteUser('${username}')" class="danger">X√≥a</button>
            ` : ''}
          </td>
        `;
        table.appendChild(row);
      }
    }
    
    // Report functions
    function loadReportFilters() {
      const userFilter = document.getElementById('reportUserFilter');
      const categoryFilter = document.getElementById('reportCategoryFilter');
      
      // Clear existing options except first
      while (userFilter.options.length > 1) userFilter.remove(1);
      while (categoryFilter.options.length > 1) categoryFilter.remove(1);
      
      // Add users
      for (const username in users) {
        const option = document.createElement('option');
        option.value = username;
        option.textContent = username;
        userFilter.appendChild(option);
      }
      
      // Add categories
      expenseCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
      });
    }
    
    function applyReportFilters() {
      const dateInput = document.getElementById('reportDate').value;
      if (!dateInput) {
        alert('Vui l√≤ng ch·ªçn ng√†y');
        return;
      }
      
      const userFilter = document.getElementById('reportUserFilter').value;
      const categoryFilter = document.getElementById('reportCategoryFilter').value;
      
      generateReport(dateInput, userFilter, categoryFilter);
    }
    
    function generateDailyReport() {
      const dateInput = document.getElementById('reportDate').value;
      if (!dateInput) {
        alert('Vui l√≤ng ch·ªçn ng√†y');
        return;
      }
      
      const userFilter = document.getElementById('reportUserFilter').value;
      const categoryFilter = document.getElementById('reportCategoryFilter').value;
      
      generateReport(dateInput, userFilter, categoryFilter);
    }
    
    function generateMonthlyReport() {
      const dateInput = document.getElementById('reportDate').value;
      if (!dateInput) {
        alert('Vui l√≤ng ch·ªçn ng√†y trong th√°ng c·∫ßn b√°o c√°o');
        return;
      }
      
      const date = new Date(dateInput);
      const month = date.getMonth() + 1;
      const year = date.getFullYear();
      
      const userFilter = document.getElementById('reportUserFilter').value;
      const categoryFilter = document.getElementById('reportCategoryFilter').value;
      
      generateReport(`${year}-${month.toString().padStart(2, '0')}`, userFilter, categoryFilter, true);
    }
    
    function generateReport(dateFilter, userFilter = 'all', categoryFilter = 'all', isMonthly = false) {
      let allDailyData = [];
      const dateStr = isMonthly 
        ? dateFilter // Format: "YYYY-MM"
        : new Date(dateFilter).toLocaleDateString('vi-VN');
      
      // Get all matching data
      for (const user in users) {
        if (userFilter !== 'all' && userFilter !== user) continue;
        
        if (isMonthly) {
          // Monthly report - check all days in month
          const [year, month] = dateFilter.split('-');
          const daysInMonth = new Date(year, month, 0).getDate();
          
          for (let day = 1; day <= daysInMonth; day++) {
            const dayStr = `${day}/${month}/${year}`;
            const dailyDataStr = localStorage.getItem(`dailyData_${dayStr}_${user}`);
            if (dailyDataStr) {
              const data = JSON.parse(dailyDataStr);
              allDailyData.push(data);
            }
          }
        } else {
          // Daily report
          const dailyDataStr = localStorage.getItem(`dailyData_${dateStr}_${user}`);
          if (dailyDataStr) {
            const data = JSON.parse(dailyDataStr);
            allDailyData.push(data);
          }
        }
      }
      
      if (allDailyData.length === 0) {
        document.getElementById('reportOutput').innerHTML = 
          `<p>Kh√¥ng c√≥ d·ªØ li·ªáu ${isMonthly ? 'th√°ng' : 'ng√†y'} ${dateStr}</p>`;
        return;
      }
      
      // Process data
      let totalRevenue = 0;
      let totalExpense = 0;
      let totalExportCost = 0;
      let expenseDetails = {};
      let exportDetails = {};
      let userNotes = [];
      let dailySummaries = [];
      
      allDailyData.forEach(data => {
        // Apply category filter
        const filteredExpenses = data.expenses.filter(expense => 
          categoryFilter === 'all' || expense.category === categoryFilter
        );
        
        // Calculate totals
        const dayExpense = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
        const dayExportCost = data.exports.reduce((sum, e) => sum + (e.quantity * e.price), 0);
        
        totalRevenue += data.revenue || 0;
        totalExpense += dayExpense;
        totalExportCost += dayExportCost;
        
        // Group expense details by category
        filteredExpenses.forEach(expense => {
          if (!expenseDetails[expense.category]) {
            expenseDetails[expense.category] = {
              amount: 0,
              items: []
            };
          }
          expenseDetails[expense.category].amount += expense.amount;
          expenseDetails[expense.category].items.push({
            description: expense.description,
            amount: expense.amount,
            user: data.user,
            date: data.date
          });
        });
        
        // Group export details by product
        data.exports.forEach(exportItem => {
          if (!exportDetails[exportItem.productName]) {
            exportDetails[exportItem.productName] = {
              quantity: 0,
              cost: 0,
              unit: exportItem.unit,
              items: []
            };
          }
          exportDetails[exportItem.productName].quantity += exportItem.quantity;
          exportDetails[exportItem.productName].cost += exportItem.quantity * exportItem.price;
          exportDetails[exportItem.productName].items.push({
            quantity: exportItem.quantity,
            user: data.user,
            date: data.date
          });
        });
        
        // Collect notes
        if (data.note && data.user) {
          userNotes.push({
            user: data.user,
            note: data.note,
            date: data.date
          });
        }
        
        // For monthly report, collect daily summaries
        if (isMonthly) {
          dailySummaries.push({
            date: data.date,
            revenue: data.revenue || 0,
            expense: dayExpense,
            exportCost: dayExportCost,
            profit: (data.revenue || 0) - dayExpense - dayExportCost
          });
        }
      });
      
      const profit = totalRevenue - totalExpense - totalExportCost;
      
      // Generate report HTML
      let reportHTML = `
        <h4>B√°o c√°o ${isMonthly ? 'th√°ng' : 'ng√†y'} ${dateStr}</h4>
        ${userFilter !== 'all' ? `<p>Ng∆∞·ªùi d√πng: ${userFilter}</p>` : ''}
        ${categoryFilter !== 'all' ? `<p>Danh m·ª•c: ${categoryFilter}</p>` : ''}
        
        <div class="summary-section">
          <h5>T·ªïng h·ª£p</h5>
          <table class="table">
            <tr>
              <td>T·ªïng doanh thu:</td>
              <td class="text-right">${totalRevenue.toLocaleString('vi-VN')}‚Ç´</td>
            </tr>
            <tr>
              <td>T·ªïng chi ph√≠:</td>
              <td class="text-right">${totalExpense.toLocaleString('vi-VN')}‚Ç´</td>
            </tr>
            <tr>
              <td>T·ªïng gi√° tr·ªã h√†ng xu·∫•t:</td>
              <td class="text-right">${totalExportCost.toLocaleString('vi-VN')}‚Ç´</td>
            </tr>
            <tr>
              <td><strong>L·ª£i nhu·∫≠n th·ª±c:</strong></td>
              <td class="text-right"><strong>${profit.toLocaleString('vi-VN')}‚Ç´</strong></td>
            </tr>
          </table>
        </div>
      `;
      
      // Add expense details
      reportHTML += `
        <div class="expense-section">
          <h5>Chi ti·∫øt chi ph√≠</h5>
          ${Object.entries(expenseDetails).map(([category, data]) => `
            <div class="category-section">
              <h6>${category}: ${data.amount.toLocaleString('vi-VN')}‚Ç´</h6>
              <table class="table">
                <thead>
                  <tr>
                    <th>M√¥ t·∫£</th>
                    <th class="text-right">S·ªë ti·ªÅn</th>
                    <th>Ng∆∞·ªùi nh·∫≠p</th>
                    <th>Ng√†y</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.items.map(item => `
                    <tr>
                      <td>${item.description}</td>
                      <td class="text-right">${item.amount.toLocaleString('vi-VN')}‚Ç´</td>
                      <td>${item.user}</td>
                      <td>${item.date}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `).join('')}
        </div>
      `;
      
      // Add export details
      reportHTML += `
        <div class="export-section">
          <h5>Chi ti·∫øt xu·∫•t h√†ng</h5>
          ${Object.entries(exportDetails).map(([product, data]) => `
            <div class="product-section">
              <h6>${product}: ${data.quantity} ${data.unit} (${data.cost.toLocaleString('vi-VN')}‚Ç´)</h6>
              <table class="table">
                <thead>
                  <tr>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>Ng∆∞·ªùi nh·∫≠p</th>
                    <th>Ng√†y</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.items.map(item => `
                    <tr>
                      <td>${item.quantity}</td>
                      <td>${item.user}</td>
                      <td>${item.date}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `).join('')}
        </div>
      `;
      
      // Add daily summaries for monthly report
      if (isMonthly && dailySummaries.length > 0) {
        reportHTML += `
          <div class="daily-summary-section">
            <h5>T·ªïng h·ª£p t·ª´ng ng√†y</h5>
            <table class="table">
              <thead>
                <tr>
                  <th>Ng√†y</th>
                  <th class="text-right">Doanh thu</th>
                  <th class="text-right">Chi ph√≠</th>
                  <th class="text-right">Xu·∫•t h√†ng</th>
                  <th class="text-right">L·ª£i nhu·∫≠n</th>
                </tr>
              </thead>
              <tbody>
                ${dailySummaries.map(day => `
                  <tr>
                    <td>${day.date}</td>
                    <td class="text-right">${day.revenue.toLocaleString('vi-VN')}‚Ç´</td>
                    <td class="text-right">${day.expense.toLocaleString('vi-VN')}‚Ç´</td>
                    <td class="text-right">${day.exportCost.toLocaleString('vi-VN')}‚Ç´</td>
                    <td class="text-right">${day.profit.toLocaleString('vi-VN')}‚Ç´</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
      
      // Add user notes
      if (userNotes.length > 0) {
        reportHTML += `
          <div class="notes-section">
            <h5>Ghi ch√∫ t·ª´ nh√¢n vi√™n</h5>
            <table class="table">
              <thead>
                <tr>
                  <th>Ng∆∞·ªùi ghi</th>
                  <th>Ghi ch√∫</th>
                  <th>Ng√†y</th>
                </tr>
              </thead>
              <tbody>
                ${userNotes.map(note => `
                  <tr>
                    <td>${note.user}</td>
                    <td>${note.note}</td>
                    <td>${note.date}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
      
      document.getElementById('reportOutput').innerHTML = reportHTML;
    }
    
    function printReport() {
      window.print();
    }
    
    // Helper functions
    function parseNumber(input) {
      if (!input) return 0;
      const cleaned = input.toString().replace(/[^\d]/g, '');
      return parseInt(cleaned) || 0;
    }
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>